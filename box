#!/bin/sh

vc_pstd () {
    printf -- "$*"
}

vc_perr () {
    vc_pstd "$@" 1>&2
}

vc_usage () {
    vc_perr "usage: $0 [-c config_file] [-k kickstart_file]"
    vc_perr " action\n"
}

vc_get_file_dir () {
    local src

    src="$1"
    while [ -h "${src}" ]; do src="$(readlink "${src}")"; done
    src=$(cd -P $(dirname "${src}") && pwd)

    vc_pstd "${src}"
}

vc_check_file_readable () {
    if [ ! -r "$1" ]; then
        vc_perr "$0: cannot read file -- $1\n"
        vc_usage
        return 1
    fi
    vc_pstd "$1"
}

vc_parse_options () {
    . "${ROOT_DIR}/etc/box.conf"
}

vc_parse_local_options () {
    local conflocal

    conflocal="${ROOT_DIR}/etc/box.conf.local"

    if [ ! -z "$1" ]; then
        conflocal="$1"
    fi

    if [ -r "${conflocal}" ]; then
        . "${conflocal}"
    fi
}

vc_parse_args () {
    local arg
    local args

    args=$(getopt -n "$0" c:k: "$@")
    if [ $? -ne 0 ]; then
        vc_usage
        exit 1
    fi

    set -- ${args}
    for arg in "$@"; do
        case "${arg}" in
            -c)
                C_CONFIG_LOCAL="$(vc_check_file_readable "$2")"; shift
                shift
                ;;
            -k)
                C_KICKSTART="$(vc_check_file_readable "$2")"; shift
                shift
                ;;
            --)
                shift
                break
                ;;
        esac
    done

    case "$1" in
        initialize|cleanup)
            ACTION="$1"; shift
            ;;
        *)
            vc_perr "$0: Unrecognised action: \"$1\".\n\n"
            vc_usage
            exit 3
            ;;
    esac
}


ROOT_DIR=$(vc_get_file_dir $0)

. "${ROOT_DIR}/src/initialize.sh"
. "${ROOT_DIR}/src/cleanup.sh"

vc_parse_options
vc_parse_args "$@"
vc_parse_local_options "${C_CONFIG_LOCAL}"

case "${ACTION}" in
    initialize)
        vc_action_initialize
        ;;
    cleanup)
        vc_action_cleanup
        ;;
esac
